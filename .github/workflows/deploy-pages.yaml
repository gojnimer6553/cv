name: Deploy to GitHub Pages

on:
  push:
    branches:
      - master
    paths:
      - 'languages/**'
      - '.github/workflows/build.yaml'
      - '.github/workflows/deploy-pages.yaml'
  workflow_dispatch:
  workflow_call:
    outputs:
      pages_url:
        description: "GitHub Pages URL where CVs are deployed"
        value: ${{ jobs.deploy.outputs.page_url }}

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    uses: ./.github/workflows/build.yaml

  deploy:
    needs: build
    runs-on: ubuntu-latest
    outputs:
      page_url: ${{ steps.deployment.outputs.page_url }}
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: ./artifacts

      - name: Checkout repository for README update
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Prepare deployment directory
        env:
          EN_PDF: ${{ needs.build.outputs.en-pdf-name }}
          PT_PDF: ${{ needs.build.outputs.pt-pdf-name }}
          EN_HTML: ${{ needs.build.outputs.en-html-name }}
          PT_HTML: ${{ needs.build.outputs.pt-html-name }}
        run: |
          mkdir -p public

          # Copy RenderCV-generated HTML files
          cp "artifacts/${EN_HTML}" public/
          cp "artifacts/${PT_HTML}" public/

          # Copy PDF files
          cp "artifacts/${EN_PDF}" public/
          cp "artifacts/${PT_PDF}" public/

      - name: Generate README.md
        env:
          EN_HTML: ${{ needs.build.outputs.en-html-name }}
          PT_HTML: ${{ needs.build.outputs.pt-html-name }}
          EN_PDF: ${{ needs.build.outputs.en-pdf-name }}
          PT_PDF: ${{ needs.build.outputs.pt-pdf-name }}
        run: |
          # Get GitHub Pages URL
          OWNER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
          REPO=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          PAGES_URL="https://${OWNER}.github.io/${REPO}"

          # Generate README
          cat > repo/README.md << EOF
          # Curriculum Vitae

          | Language | Preview (HTML) | PDF |
          |----------|----------------|------|
          | ðŸ‡ºðŸ‡¸ English | [Preview](${PAGES_URL}/${EN_HTML}) | [Download](${PAGES_URL}/${EN_PDF}) |
          | ðŸ‡§ðŸ‡· Portuguese | [Preview](${PAGES_URL}/${PT_HTML}) | [Download](${PAGES_URL}/${PT_PDF}) |

          ---

          *Built with [RenderCV](https://rendercv.com)*
          EOF

      - name: Create index.html
        env:
          EN_HTML: ${{ needs.build.outputs.en-html-name }}
          PT_HTML: ${{ needs.build.outputs.pt-html-name }}
          EN_PDF: ${{ needs.build.outputs.en-pdf-name }}
          PT_PDF: ${{ needs.build.outputs.pt-pdf-name }}
        run: |
          cat > public/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Curriculum Vitae</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                      max-width: 800px;
                      margin: 50px auto;
                      padding: 20px;
                      line-height: 1.6;
                      color: #333;
                  }
                  h1 {
                      border-bottom: 2px solid #333;
                      padding-bottom: 10px;
                  }
                  table {
                      width: 100%;
                      border-collapse: collapse;
                      margin: 30px 0;
                  }
                  th, td {
                      padding: 12px;
                      text-align: left;
                      border-bottom: 1px solid #ddd;
                  }
                  th {
                      background-color: #f5f5f5;
                      font-weight: 600;
                  }
                  a {
                      color: #0066cc;
                      text-decoration: none;
                  }
                  a:hover {
                      text-decoration: underline;
                  }
                  .footer {
                      margin-top: 50px;
                      padding-top: 20px;
                      border-top: 1px solid #ddd;
                      color: #666;
                      font-size: 0.9em;
                  }
              </style>
          </head>
          <body>
              <h1>Curriculum Vitae</h1>
              <table>
                  <thead>
                      <tr>
                          <th>Language</th>
                          <th>Preview (HTML)</th>
                          <th>PDF</th>
                      </tr>
                  </thead>
                  <tbody>
          EOF

          cat >> public/index.html << EOF
                      <tr>
                          <td>ðŸ‡ºðŸ‡¸ English</td>
                          <td><a href="${EN_HTML}">Preview</a></td>
                          <td><a href="${EN_PDF}">Download</a></td>
                      </tr>
                      <tr>
                          <td>ðŸ‡§ðŸ‡· Portuguese</td>
                          <td><a href="${PT_HTML}">Preview</a></td>
                          <td><a href="${PT_PDF}">Download</a></td>
                      </tr>
          EOF

          cat >> public/index.html << 'EOF'
                  </tbody>
              </table>
              <div class="footer">
                  <em>Built with <a href="https://rendercv.com" target="_blank" rel="noopener">RenderCV</a></em>
              </div>
          </body>
          </html>
          EOF

      - name: Commit updated README
        run: |
          cd repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to README.md"
          else
            git commit -m "docs: Update CV links in README [skip ci]"
            git push
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './public'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment summary
        env:
          PAGES_URL: ${{ steps.deployment.outputs.page_url }}
          EN_HTML: ${{ needs.build.outputs.en-html-name }}
          PT_HTML: ${{ needs.build.outputs.pt-html-name }}
          EN_PDF: ${{ needs.build.outputs.en-pdf-name }}
          PT_PDF: ${{ needs.build.outputs.pt-pdf-name }}
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Successfully deployed to GitHub Pages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Landing Page | [${PAGES_URL}](${PAGES_URL}) |" >> $GITHUB_STEP_SUMMARY
          echo "| English HTML | [${PAGES_URL}${EN_HTML}](${PAGES_URL}${EN_HTML}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Portuguese HTML | [${PAGES_URL}${PT_HTML}](${PAGES_URL}${PT_HTML}) |" >> $GITHUB_STEP_SUMMARY
          echo "| English PDF | [${PAGES_URL}${EN_PDF}](${PAGES_URL}${EN_PDF}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Portuguese PDF | [${PAGES_URL}${PT_PDF}](${PAGES_URL}${PT_PDF}) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Direct Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ‡ºðŸ‡¸ English: [HTML](${PAGES_URL}${EN_HTML}) | [PDF](${PAGES_URL}${EN_PDF})" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ‡§ðŸ‡· Portuguese: [HTML](${PAGES_URL}${PT_HTML}) | [PDF](${PAGES_URL}${PT_PDF})" >> $GITHUB_STEP_SUMMARY
